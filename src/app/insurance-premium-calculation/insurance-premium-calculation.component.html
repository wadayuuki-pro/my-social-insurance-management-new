<div class="insurance-premium-container">
  <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±è¡¨ç¤º -->
  <div class="dashboard-user-info" style="position: absolute; top: 1.2rem; right: 2.5rem; background: #e3f2fd; color: #1976d2; border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);">
    <ng-container *ngIf="isAuthReady$ | async as isReady">
      <ng-container *ngIf="isReady; else loading">
        <ng-container *ngIf="employeeInfo$ | async as info; else notLoggedIn">
          <span *ngIf="info; else notLoggedIn">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šä¼šç¤¾ID:{{ info.company_id }}ï¼ç¤¾å“¡ID:{{ info.employee_code }}ï¼æ°å:{{ info.name }}
          </span>
        </ng-container>
        <ng-template #notLoggedIn>
          <ng-container *ngIf="user$ | async as user">
            <span *ngIf="user?.email">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š{{ user.email }}</span>
            <span *ngIf="!user?.email">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</span>
          </ng-container>
        </ng-template>
      </ng-container>
      <ng-template #loading>
        <span>èªè¨¼ç¢ºèªä¸­...</span>
      </ng-template>
    </ng-container>
  </div>
  <h1>ä¿é™ºæ–™ç®¡ç†</h1>
  <div class="tab-header">
    <button [class.active]="selectedTab === 'calculation'" (click)="selectTab('calculation')">ğŸ’¼ ä¿é™ºæ–™è¨ˆç®—</button>
    <button [class.active]="selectedTab === 'ratio'" (click)="selectTab('ratio')">âš–ï¸ ä¿é™ºæ–™è² æ‹…å†…è¨³</button>    
    <button [class.active]="selectedTab === 'history'" (click)="selectTab('history')">ğŸ“œ å±¥æ­´é–²è¦§</button>
  </div>

  <div class="tab-content">
    <ng-container *ngIf="selectedTab === 'calculation'">
      <h2>ä¿é™ºæ–™è¨ˆç®—</h2>
      <!-- æ³¨æ„æ›¸ãã‚’è¿½åŠ  -->
      <div style="margin-bottom: 1rem; background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; border-radius: 6px; padding: 0.5rem 0.8rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 1px 4px rgba(230,81,0,0.08); font-size: 0.95rem;">
        <mat-icon style="color: #e65100; font-size: 1.2rem; height: 1.2rem; width: 1.2rem;">warning</mat-icon>
        <span style="font-weight: 500;">è¨ˆç®—å®Ÿè¡Œå¾Œã¯å¿…ãšä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
      </div>
      <div class="section">
        <div class="form-group">
          <label for="department">äº‹æ¥­æ‰€ï¼ˆéƒ¨ç½²ï¼‰<span style="color: #d32f2f;">*</span></label>
          <select id="department" [(ngModel)]="selectedDepartmentId" name="department" (change)="onDepartmentChange()" required>
            <option value="">äº‹æ¥­æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="employeeSearch">å¾“æ¥­å“¡æ¤œç´¢ï¼ˆæ°åãƒ»IDï¼‰</label>
          <input type="text" id="employeeSearch" placeholder="æ°åãƒ»IDã§æ¤œç´¢" [(ngModel)]="searchText" (ngModelChange)="filterEmployees()" name="employeeSearch" />
        </div>

        <div class="form-group">
          <label for="employee">å¾“æ¥­å“¡<span style="color: #d32f2f;">*</span></label>
          <select id="employee" [(ngModel)]="selectedEmployeeId" name="employee" (change)="onEmployeeSelect()" required>
            <option value="">å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let emp of filteredEmployees" [value]="emp.id">
              {{emp.last_name_kanji}}{{emp.first_name_kanji}} ({{emp.employee_code}})
            </option>
          </select>
        </div>


        <div class="form-group">
          <label for="yearSelect">å¯¾è±¡å¹´åº¦</label>
          <select id="yearSelect" [(ngModel)]="selectedYear" name="yearSelect" (change)="onYearChange()" required>
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>

        <div class="form-group">
          <label for="monthSelect">å¯¾è±¡æœˆ</label>
          <select id="monthSelect" [(ngModel)]="selectedMonth" name="monthSelect" (change)="onMonthChange()" required>
            <option *ngFor="let m of monthOptions" [value]="m">{{ m }}æœˆ</option>
          </select>
        </div>

        <div class="form-group" *ngIf="selectedEmployeeId">
          <label>è³ä¸é¡</label>
          <div *ngIf="hasBonus" style="color: #1976d2; font-weight: 500;">
            {{ bonusAmount.toNumber() | number }}å††
          </div>
          <div *ngIf="!hasBonus" style="color: #d32f2f; font-weight: 500;">
            è³ä¸ã¯ã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>

      <div class="section">
        <div class="button-row">
          <button type="button" (click)="calculateInsurance()" [disabled]="!selectedEmployeeId">
            <mat-icon>calculate</mat-icon>
            è¨ˆç®—å®Ÿè¡Œ
          </button>
          <button type="button" (click)="calculateBonusInsurance()" [disabled]="!selectedEmployeeId" class="bonus-btn">
            <mat-icon>payments</mat-icon>
            è³ä¸è¨ˆç®—
          </button>
          <button type="button" (click)="onAllEmployeesCalculate()" [disabled]="!selectedDepartmentId" class="all-btn">
            <mat-icon>group</mat-icon>
            å…¨å¾“æ¥­å“¡è¨ˆç®—
          </button>
          <button type="button" (click)="onAllEmployeesBonusCalculate()" [disabled]="!selectedDepartmentId" class="all-btn">
            <mat-icon>group</mat-icon>
            å…¨å¾“æ¥­å“¡è³ä¸è¨ˆç®—
          </button>
          <button type="button" (click)="toggleRoundingPattern()" class="rounding-btn">
            <mat-icon>swap_horiz</mat-icon>
            <span *ngIf="roundingPattern === 'round'">å››æ¨äº”å…¥:ç¾é‡‘æ‰•ã„</span>
            <span *ngIf="roundingPattern === 'custom'">å››æ¨äº”å…¥:çµ¦ä¸ã‹ã‚‰æ§é™¤</span>
          </button>
          <button type="button" (click)="saveCalculationResult()" *ngIf="calculationResultTotalNumber > 0 && !isBonusCalculation" class="save-btn">
            <mat-icon>save</mat-icon>
            è¨ˆç®—çµæœã‚’ä¿å­˜
          </button>
          <button type="button" (click)="saveBonusCalculationResult()" *ngIf="bonusCalculationResultTotalNumber > 0 && isBonusCalculation" class="save-btn">
            <mat-icon>save</mat-icon>
            è³ä¸è¨ˆç®—çµæœã‚’ä¿å­˜
          </button>
          <button type="button" (click)="saveAllEmployeesResults()" *ngIf="succeededEmployees.length > 0" [disabled]="isSavingAll" class="save-btn">
            <mat-icon>save</mat-icon>
            å…¨å“¡åˆ†ä¿å­˜
          </button>
          <button type="button" (click)="saveAllEmployeesBonusResults()" *ngIf="succeededBonusEmployees.length > 0" [disabled]="isSavingAllBonus" class="save-btn">
            <mat-icon>save</mat-icon>
            å…¨å“¡åˆ†è³ä¸ä¿å­˜
          </button>
          <span *ngIf="saveAllMessage" style="margin-left: 1em; color: #1976d2;">{{ saveAllMessage }}</span>
          <span *ngIf="saveAllBonusMessage" style="margin-left: 1em; color: #1976d2;">{{ saveAllBonusMessage }}</span>
        </div>
      </div>

      <div class="section" *ngIf="(calculationResultTotalNumber > 0 && !isBonusCalculation) || (bonusCalculationResultTotalNumber > 0 && isBonusCalculation)">
        <!-- è¨ˆç®—æ ¹æ‹ ã®è¡¨ç¤ºã‚’è¿½åŠ  -->
        <div class="calculation-summary" style="margin-bottom: 1rem; color: #1976d2; font-weight: 500;">
          <div>å¯¾è±¡å¹´æœˆï¼š{{ displayYear }}å¹´{{ selectedMonth }}æœˆ</div>
          <div>ç­‰ç´šï¼š{{ selectedGrade !== null ? selectedGrade : '-' }}</div>
          <div>æ¨™æº–å ±é…¬æœˆé¡ï¼š{{ selectedGradeInfo?.standardSalary | number }}å††</div>
          <div>å¹´é½¢ï¼š{{ selectedEmployeeAge !== null ? selectedEmployeeAge : '-' }}æ­³</div>
          <div *ngIf="isBonusCalculation">è³ä¸é¡ï¼š{{ bonusAmount.toNumber() | number }}å††</div>
        </div>
        <div *ngIf="isBonusCalculation && isBonusLoading" style="color:#1976d2; font-weight:500; text-align:center; margin:2em 0;">è¨ˆç®—ä¸­...</div>
        <div class="table-container" *ngIf="!isBonusCalculation || (isBonusCalculation && !isBonusLoading)">
          <table class="premium-table">
            <thead>
              <tr>
                <th>é …ç›®</th>
                <th>é‡‘é¡</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="!isBonusCalculation">
                <tr>
                  <td>å¥åº·ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.ippan; else notApplicable">
                      {{ getDisplayValue(calculationResult.ippanFull) | number }}å††
                    </ng-container>
                    <ng-template #notApplicable>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>å¥åº·ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.ippan; else notApplicable2">
                      {{ getDisplayValue(calculationResult.ippanHalf) | number:'1.0-0' }}å††
                    </ng-container>
                    <ng-template #notApplicable2>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>å¥åº·ä¿é™ºæ–™2å·ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.tokutei; else notApplicableTokutei1">{{ selectedGradeInfo?.tokutei?.full | number }}å††</ng-container>
                    <ng-template #notApplicableTokutei1>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>å¥åº·ä¿é™ºæ–™2å·ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.tokutei; else notApplicableTokutei2">
                      {{ getDisplayValue(calculationResult.tokuteiHalf) | number:'1.0-0' }}å††
                    </ng-container>
                    <ng-template #notApplicableTokutei2>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.kousei; else notApplicable3">{{ selectedGradeInfo?.kousei?.full | number }}å††</ng-container>
                    <ng-template #notApplicable3>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.kousei; else notApplicable4">{{ displayKouseiHalf | number }}å††</ng-container>
                    <ng-template #notApplicable4>-</ng-template>
                  </td>
                </tr>
              </ng-container>
              <ng-container *ngIf="isBonusCalculation">
                <tr>
                  <td>è³ä¸å¥åº·ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.ippan; else notApplicable5">
                      {{ getDisplayValue(bonusCalculationResult.ippanFull) | number }}å††
                    </ng-container>
                    <ng-template #notApplicable5>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>è³ä¸å¥åº·ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.ippan; else notApplicable6">
                      {{ getDisplayValue(bonusCalculationResult.ippanHalf) | number }}å††
                    </ng-container>
                    <ng-template #notApplicable6>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>è³ä¸å¥åº·ä¿é™ºæ–™2å·ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.tokutei; else notApplicableTokutei3">
                      {{ getDisplayValue(bonusCalculationResult.tokuteiFull) | number }}å††
                    </ng-container>
                    <ng-template #notApplicableTokutei3>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>è³ä¸å¥åº·ä¿é™ºæ–™2å·ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.tokutei; else notApplicableTokutei4">
                      {{ getDisplayValue(bonusCalculationResult.tokuteiHalf) | number }}å††
                    </ng-container>
                    <ng-template #notApplicableTokutei4>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>è³ä¸åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.kousei; else notApplicable7">
                      {{ getDisplayValue(bonusCalculationResult.kouseiFull) | number }}å††
                    </ng-container>
                    <ng-template #notApplicable7>-</ng-template>
                  </td>
                </tr>
                <tr>
                  <td>è³ä¸åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</td>
                  <td>
                    <ng-container *ngIf="_lastInsuranceApplicable.kousei; else notApplicable8">
                      {{ getDisplayValue(bonusCalculationResult.kouseiHalf) | number }}å††
                    </ng-container>
                    <ng-template #notApplicable8>-</ng-template>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>

      <div *ngIf="failedEmployees && failedEmployees.length > 0" style="margin: 1.5em 0; background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; border-radius: 10px; padding: 1.2em 2em; max-width: 600px;">
        <b>è¨ˆç®—ã§ããªã‹ã£ãŸå¾“æ¥­å“¡ï¼š</b>
        <ul style="margin: 0.5em 0 0 1.2em;">
          <li *ngFor="let emp of failedEmployees">{{ emp.last_name_kanji }}{{ emp.first_name_kanji }} ({{ emp.employee_code }})</li>
        </ul>
      </div>

      <div *ngIf="succeededEmployees && succeededEmployees.length > 0" style="margin: 1.5em 0; background: #e3f2fd; color: #1976d2; border: 1.5px solid #bbdefb; border-radius: 10px; padding: 1.2em 2em; max-width: 700px;">
        <b>è¨ˆç®—ã§ããŸå¾“æ¥­å“¡ï¼š</b>
        <table style="width:100%; margin-top:0.7em; background:#fff; border-radius:8px;">
          <thead>
            <tr style="background:#e3f2fd; color:#1976d2;">
              <th style="padding:0.5em 1em;">æ°å</th>
              <th style="padding:0.5em 1em;">å¥åº·ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">å¥åº·ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</th>
              <th style="padding:0.5em 1em;">å¥åº·ä¿é™ºæ–™2å·ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">å¥åº·ä¿é™ºæ–™2å·ï¼ˆåŠé¡ï¼‰</th>
              <th style="padding:0.5em 1em;">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of succeededEmployees">
              <td style="padding:0.5em 1em;">{{ emp.name }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.ippanApplicable ? (emp.ippanFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.ippanApplicable ? (emp.ippanHalf | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.tokuteiApplicable ? (emp.tokuteiFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.tokuteiApplicable ? (emp.tokuteiHalf | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.kouseiApplicable ? (emp.kouseiFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.kouseiApplicable ? (emp.kouseiHalf | number) + 'å††' : '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="failedBonusEmployees && failedBonusEmployees.length > 0" style="margin: 1.5em 0; background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; border-radius: 10px; padding: 1.2em 2em; max-width: 600px;">
        <b>è³ä¸è¨ˆç®—ã§ããªã‹ã£ãŸå¾“æ¥­å“¡ï¼š</b>
        <ul style="margin: 0.5em 0 0 1.2em;">
          <li *ngFor="let emp of failedBonusEmployees">{{ emp.last_name_kanji }}{{ emp.first_name_kanji }} ({{ emp.employee_code }})</li>
        </ul>
      </div>

      <div *ngIf="succeededBonusEmployees && succeededBonusEmployees.length > 0" style="margin: 1.5em 0; background: #e3f2fd; color: #1976d2; border: 1.5px solid #bbdefb; border-radius: 10px; padding: 1.2em 2em; max-width: 900px;">
        <b>è³ä¸è¨ˆç®—ã§ããŸå¾“æ¥­å“¡ï¼š</b>
        <table style="width:100%; margin-top:0.7em; background:#fff; border-radius:8px;">
          <thead>
            <tr style="background:#e3f2fd; color:#1976d2;">
              <th style="padding:0.5em 1em;">æ°å</th>
              <th style="padding:0.5em 1em;">è³ä¸é¡</th>
              <th style="padding:0.5em 1em;">è³ä¸å¥åº·ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">è³ä¸å¥åº·ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</th>
              <th style="padding:0.5em 1em;">è³ä¸å¥åº·ä¿é™ºæ–™2å·ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">è³ä¸å¥åº·ä¿é™ºæ–™2å·ï¼ˆåŠé¡ï¼‰</th>
              <th style="padding:0.5em 1em;">è³ä¸åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
              <th style="padding:0.5em 1em;">è³ä¸åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of succeededBonusEmployees">
              <td style="padding:0.5em 1em;">{{ emp.name }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.bonusAmount | number }}å††</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.ippanApplicable ? (emp.ippanFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.ippanApplicable ? (emp.ippanHalf | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.tokuteiApplicable ? (emp.tokuteiFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.tokuteiApplicable ? (emp.tokuteiHalf | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.kouseiApplicable ? (emp.kouseiFull | number) + 'å††' : '-' }}</td>
              <td style="padding:0.5em 1em; text-align:right;">{{ emp.kouseiApplicable ? (emp.kouseiHalf | number) + 'å††' : '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'ratio'">
      <h2>ä¿é™ºæ–™è² æ‹…å†…è¨³</h2>
      <div class="section burden-ratio-section">
        <div class="form-group">
          <label for="department-ratio">äº‹æ¥­æ‰€</label>
          <select id="department-ratio" [(ngModel)]="selectedDepartmentId" name="department-ratio" (change)="onDepartmentChange()">
            <option value="">äº‹æ¥­æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="yearSelect-ratio">å¯¾è±¡å¹´åº¦</label>
          <select id="yearSelect-ratio" [(ngModel)]="selectedYear" name="yearSelect-ratio" (change)="onRatioDateChange()">
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>
        <div class="form-group">
          <label for="monthSelect-ratio">å¯¾è±¡æœˆ</label>
          <select id="monthSelect-ratio" [(ngModel)]="selectedMonth" name="monthSelect-ratio" (change)="onRatioDateChange()">
            <option *ngFor="let m of monthOptions" [value]="m">{{ m }}æœˆ</option>
          </select>
        </div>
        <div class="table-responsive" *ngIf="employeePremiumSummaries.length > 0">
          <div style="margin-bottom: 1.5rem;">
            <div class="burden-summary-cards" style="display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap;">
              <!-- å¥åº·ä¿é™ºæ–™ã®ä¼šç¤¾è² æ‹… -->
              <div style="background: #e3f2fd; color: #1976d2; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">å¥åº·ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</div>
                <div style="font-size: 2em; font-weight: bold;">{{ (totalCompanyBurden.minus(totalKouseiCompanyBurden)).toNumber() | number }}
                  <span *ngIf="hasFraction(totalCompanyBurden.minus(totalKouseiCompanyBurden))" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ (totalCompanyBurden.minus(totalKouseiCompanyBurden)).floor().toNumber() | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <!-- å¥åº·ä¿é™ºæ–™ã®å¾“æ¥­å“¡è² æ‹… -->
              <div style="background: #fff3e0; color: #fb8c00; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(251, 140, 0, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">å¥åº·ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</div>
                <div style="font-size: 2em; font-weight: bold;">{{ (totalEmployeeBurden.minus(totalKouseiEmployeeBurden)).toNumber() | number }}
                  <span *ngIf="hasFraction(totalEmployeeBurden.minus(totalKouseiEmployeeBurden))" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ (totalEmployeeBurden.minus(totalKouseiEmployeeBurden)).floor().toNumber() | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <!-- åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ã®ä¼šç¤¾è² æ‹… -->
              <div style="background: #e3f2fd; color: #1976d2; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalKouseiCompanyBurden.toNumber() | number }}
                  <span *ngIf="hasFraction(totalKouseiCompanyBurden)" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalKouseiCompanyBurden.floor().toNumber() | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <!-- åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ã®å¾“æ¥­å“¡è² æ‹… -->
              <div style="background: #fff3e0; color: #fb8c00; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(251, 140, 0, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalKouseiEmployeeBurden.toNumber() | number }}
                  <span *ngIf="hasFraction(totalKouseiEmployeeBurden)" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalKouseiEmployeeBurden.floor().toNumber() | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <!-- ç·åˆè¨ˆ -->
              <div style="background: #e8f5e9; color: #388e3c; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(56, 142, 60, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">ç·åˆè¨ˆ</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalBurden.toNumber() | number }}
                  <span *ngIf="totalBurdenHasFraction" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalBurdenFloor | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
            </div>
            <div style="text-align: center; margin-top: 2.5rem;">
              <button type="button" (click)="saveBurdenRatio()" style="background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #fff; font-weight: bold; font-size: 1.1em; border-radius: 2em; padding: 1em 2.5em; box-shadow: 0 2px 8px rgba(56, 142, 60, 0.12); border: none; outline: none; cursor: pointer; transition: background 0.2s;">
                <mat-icon>save</mat-icon>
                è² æ‹…æ¯”ç‡é›†è¨ˆã‚’ä¿å­˜
              </button>
              <button type="button" (click)="toggleDateFormat()" style="margin-left: 1em; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); color: #fff; font-weight: bold; font-size: 1.1em; border-radius: 2em; padding: 1em 2.5em; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.12); border: none; outline: none; cursor: pointer; transition: background 0.2s;">
                <mat-icon>swap_horiz</mat-icon>
                {{ showOnlyFormattedDates ? 'å…¨ã¦ã®åˆè¨ˆã‚’è¡¨ç¤º' : 'è³ä¸ã®ä¿é™ºæ–™ã®ã¿è¡¨ç¤º' }}
              </button>
            </div>
          </div>
          <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
            <table class="premium-table" style="margin-bottom: 0;">
              <thead style="position: sticky; top: 0; z-index: 1; background: #e3f2fd;">
                <tr>
                  <th>æ°å</th>
                  <th>å¥åº·ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                  <th>å¥åº·ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                  <th>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ï¼‰ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                  <th>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ï¼‰ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                  <th>ä»‹è­·ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                  <th>ä»‹è­·ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                  <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                  <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                  <th>å¾“æ¥­å“¡è² æ‹…åˆè¨ˆ</th>
                  <th>ä¼šç¤¾è² æ‹…åˆè¨ˆ</th>
                  <th>ç·åˆè¨ˆ</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of employeePremiumSummaries">
                  <td>{{ row.name }}</td>
                  <td>{{ row.ippanEmployee.gt(0) ? (row.ippanEmployee.toNumber() | number) : '' }}</td>
                  <td>{{ row.ippanCompany.gt(0) ? (row.ippanCompany.toNumber() | number) : '' }}</td>
                  <td>{{ row.tokuteiEmployee.gt(0) ? (row.tokuteiEmployee.toNumber() | number) : '' }}</td>
                  <td>{{ row.tokuteiCompany.gt(0) ? (row.tokuteiCompany.toNumber() | number) : '' }}</td>
                  <td>{{ row.kaigoEmployee.gt(0) ? (row.kaigoEmployee.toNumber() | number) : '' }}</td>
                  <td>{{ row.kaigoCompany.gt(0) ? (row.kaigoCompany.toNumber() | number) : '' }}</td>
                  <td>{{ row.kouseiEmployee.gt(0) ? (row.kouseiEmployee.toNumber() | number) : '' }}</td>
                  <td>{{ row.kouseiCompany.gt(0) ? (row.kouseiCompany.toNumber() | number) : '' }}</td>
                  <td>{{ row.totalEmployee.toNumber() | number }}</td>
                  <td>{{ row.totalCompany.toNumber() | number }}</td>
                  <td>{{ row.total.toNumber() | number }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'history'">
      <h2>å±¥æ­´é–²è¦§</h2>
      <div class="section">
        <div class="form-group">
          <label for="historyYearSelect">å¹´åº¦</label>
          <select id="historyYearSelect" [(ngModel)]="selectedHistoryYear" name="historyYearSelect" (change)="onHistorySelectionChange()">
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>
        <div class="form-group">
          <label for="historyPrefectureSelect">éƒ½é“åºœçœŒ</label>
          <select id="historyPrefectureSelect" [(ngModel)]="selectedHistoryPrefectureId" name="historyPrefectureSelect" (change)="onHistorySelectionChange()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let pref of prefectures" [value]="pref.id">{{ pref.id }}</option>
          </select>
        </div>
        <div *ngIf="historyPrefectureRates">
          <h3 style="margin-bottom: 1em;">æ–™ç‡æƒ…å ±</h3>
          <div style="display: flex; gap: 1.5em; flex-wrap: wrap;">
            <div style="background: #e3f2fd; border-radius: 1em; padding: 1.2em 2em; min-width: 180px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08); text-align: center;">
              <div style="font-weight: bold; color: #1976d2;">å¥åº·ä¿é™ºæ–™</div>
              <div style="font-size: 1.5em; font-weight: bold;">{{ historyPrefectureRates.ippan_rate != null ? historyPrefectureRates.ippan_rate : '-' }}</div>
            </div>
            <div style="background: #fff3e0; border-radius: 1em; padding: 1.2em 2em; min-width: 180px; box-shadow: 0 2px 8px rgba(251, 140, 0, 0.08); text-align: center;">
              <div style="font-weight: bold; color: #fb8c00;">å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ï¼‰</div>
              <div style="font-size: 1.5em; font-weight: bold;">{{ historyPrefectureRates.tokutei_rate != null ? historyPrefectureRates.tokutei_rate : '-' }}</div>
            </div>
            <div style="background: #fce4ec; border-radius: 1em; padding: 1.2em 2em; min-width: 180px; box-shadow: 0 2px 8px rgba(233, 30, 99, 0.08); text-align: center;">
              <div style="font-weight: bold; color: #c2185b;">ä»‹è­·ä¿é™ºæ–™</div>
              <div style="font-size: 1.5em; font-weight: bold;">{{ historyKaigoRate != null ? historyKaigoRate : '-' }}</div>
            </div>
            <div style="background: #e8f5e9; border-radius: 1em; padding: 1.2em 2em; min-width: 180px; box-shadow: 0 2px 8px rgba(56, 142, 60, 0.08); text-align: center;">
              <div style="font-weight: bold; color: #388e3c;">åšç”Ÿå¹´é‡‘ä¿é™ºæ–™</div>
              <div style="font-size: 1.5em; font-weight: bold;">{{ historyPrefectureRates.kousei_rate != null ? historyPrefectureRates.kousei_rate : '-' }}</div>
            </div>
          </div>
          <div style="margin-top: 1.5em; display: flex; justify-content: center;">
            <div style="background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; border-radius: 10px; padding: 1.2em 2em; max-width: 600px; width: 100%; display: flex; align-items: flex-start; gap: 1em; box-shadow: 0 2px 8px rgba(198,40,40,0.08); font-size: 1.05em;">
              <span style="font-size: 1.7em; margin-top: -0.1em;">âš ï¸</span>
              <span>
                <b>å”ä¼šã‘ã‚“ã½ã®ä¿é™ºæ–™ç‡ã¯ï¼“æœˆåˆ†ï¼ˆï¼”æœˆç´ä»˜åˆ†ï¼‰ã‹ã‚‰é©ç”¨ã•ã‚Œã¾ã™ã€‚</b><br>
                <span style="font-size: 0.98em;">ï¼ˆ4æœˆåˆ†ã®ä¿é™ºæ–™ã‹ã‚‰å¤‰ã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ï¼‰</span>
              </span>
            </div>
          </div>
        </div>
        <div *ngIf="historyPrefectureRatesError" style="color:#d32f2f; font-weight:bold;">{{ historyPrefectureRatesError }}</div>
      </div>
    </ng-container>
  </div>
</div>
