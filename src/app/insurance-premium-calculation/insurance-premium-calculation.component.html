<div class="insurance-premium-container">
  <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±è¡¨ç¤º -->
  <div class="dashboard-user-info" style="position: absolute; top: 1.2rem; right: 2.5rem; background: #e3f2fd; color: #1976d2; border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);">
    <ng-container *ngIf="isAuthReady$ | async as isReady">
      <ng-container *ngIf="isReady; else loading">
        <ng-container *ngIf="employeeInfo$ | async as info; else notLoggedIn">
          <span *ngIf="info; else notLoggedIn">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šä¼šç¤¾ID:{{ info.company_id }}ï¼ç¤¾å“¡ID:{{ info.employee_code }}ï¼æ°å:{{ info.name }}
          </span>
        </ng-container>
        <ng-template #notLoggedIn>
          <ng-container *ngIf="user$ | async as user">
            <span *ngIf="user?.email">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š{{ user.email }}</span>
            <span *ngIf="!user?.email">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</span>
          </ng-container>
        </ng-template>
      </ng-container>
      <ng-template #loading>
        <span>èªè¨¼ç¢ºèªä¸­...</span>
      </ng-template>
    </ng-container>
  </div>
  <h1>ä¿é™ºæ–™ç®¡ç†</h1>
  <div class="tab-header">
    <button [class.active]="selectedTab === 'calculation'" (click)="selectTab('calculation')">ğŸ’¼ ä¿é™ºæ–™è¨ˆç®—</button>
    <button [class.active]="selectedTab === 'ratio'" (click)="selectTab('ratio')">âš–ï¸ è² æ‹…æ¯”ç‡</button>
    <button [class.active]="selectedTab === 'master'" (click)="selectTab('master')">ğŸ“‹ ãƒã‚¹ã‚¿ç®¡ç†</button>
    <button [class.active]="selectedTab === 'history'" (click)="selectTab('history')">ğŸ“œ å±¥æ­´é–²è¦§</button>
    <button [class.active]="selectedTab === 'table'" (click)="selectTab('table')">ğŸ¥ ä¿é™ºæ–™è¡¨ç®¡ç†</button>
  </div>

  <div class="tab-content">
    <ng-container *ngIf="selectedTab === 'calculation'">
      <h2>ä¿é™ºæ–™è¨ˆç®—</h2>
      <div class="section">
        <div class="form-group">
          <label for="department">äº‹æ¥­æ‰€ï¼ˆéƒ¨ç½²ï¼‰</label>
          <select id="department" [(ngModel)]="selectedDepartmentId" name="department" (change)="onDepartmentChange()">
            <option value="">å…¨ã¦ã®äº‹æ¥­æ‰€</option>
            <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="employeeSearch">å¾“æ¥­å“¡æ¤œç´¢ï¼ˆæ°åãƒ»IDï¼‰</label>
          <input type="text" id="employeeSearch" placeholder="æ°åãƒ»IDã§æ¤œç´¢" [(ngModel)]="searchText" (ngModelChange)="filterEmployees()" name="employeeSearch" />
        </div>

        <div class="form-group">
          <label for="employee">å¾“æ¥­å“¡</label>
          <select id="employee" [(ngModel)]="selectedEmployeeId" name="employee" (change)="onEmployeeSelect()" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let emp of filteredEmployees" [value]="emp.id">
              {{emp.last_name_kanji}}{{emp.first_name_kanji}} ({{emp.employee_code}})
            </option>
          </select>
        </div>

        <!-- é¸æŠä¸­ã®éƒ½é“åºœçœŒIDè¡¨ç¤º -->
        <div class="form-group">
          <ng-container *ngIf="selectedPrefectureId; else noDept">
            <span style="color:#1976d2; font-weight:500;">é¸æŠä¸­ã®éƒ½é“åºœçœŒIDï¼š{{ selectedPrefectureId }}</span>
          </ng-container>
          <ng-template #noDept>
            <span style="color:#d32f2f; font-weight:500;">äº‹æ¥­æ‰€ï¼ˆéƒ¨ç½²ï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
          </ng-template>
        </div>

        <div class="form-group">
          <label for="yearSelect">å¯¾è±¡å¹´åº¦</label>
          <select id="yearSelect" [(ngModel)]="selectedYear" name="yearSelect" (change)="onYearChange()" required>
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>

        <div class="form-group">
          <label for="monthSelect">å¯¾è±¡æœˆ</label>
          <select id="monthSelect" [(ngModel)]="selectedMonth" name="monthSelect" (change)="onMonthChange()" required>
            <option *ngFor="let m of monthOptions" [value]="m">{{ m }}æœˆ</option>
          </select>
        </div>
      </div>

      <div class="section">
        <div class="button-row">
          <button type="button" (click)="calculateInsurance()">
            <mat-icon>calculate</mat-icon>
            è¨ˆç®—å®Ÿè¡Œ
          </button>
          <button type="button" (click)="toggleRoundingPattern()" style="margin-left: 1rem; background: #1976d2; color: white;">
            <mat-icon>swap_horiz</mat-icon>
            å››æ¨äº”å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿ï¼š
            <span *ngIf="roundingPattern === 'round'">0.5ä»¥ä¸‹åˆ‡ã‚Šæ¨ã¦ãƒ»0.5è¶…åˆ‡ã‚Šä¸Šã’</span>
            <span *ngIf="roundingPattern === 'custom'">0.5æœªæº€åˆ‡ã‚Šæ¨ã¦ãƒ»0.5ä»¥ä¸Šåˆ‡ã‚Šä¸Šã’</span>
          </button>
          <button type="button" (click)="saveCalculationResult()" *ngIf="calculationResult.total > 0" style="margin-left: 1rem; background: #4caf50; color: white;">
            <mat-icon>save</mat-icon>
            è¨ˆç®—çµæœã‚’ä¿å­˜
          </button>
        </div>
      </div>

      <div class="section" *ngIf="calculationResult.total > 0">
        <!-- è¨ˆç®—æ ¹æ‹ ã®è¡¨ç¤ºã‚’è¿½åŠ  -->
        <div class="calculation-summary" style="margin-bottom: 1rem; color: #1976d2; font-weight: 500;">
          <div>å¯¾è±¡å¹´æœˆï¼š{{ selectedYear }}å¹´{{ selectedMonth }}æœˆ</div>
          <div>ç­‰ç´šï¼š{{ selectedGrade !== null ? selectedGrade : '-' }}</div>
          <div>æ¨™æº–å ±é…¬æœˆé¡ï¼š{{ selectedGradeInfo?.standardSalary | number }}å††</div>
          <div>å¹´é½¢ï¼š{{ selectedEmployeeAge !== null ? selectedEmployeeAge : '-' }}æ­³</div>
        </div>
        <h3>è¨ˆç®—çµæœ</h3>
        <div class="table-container">
          <table class="premium-table">
            <thead>
              <tr>
                <th>é …ç›®</th>
                <th>é‡‘é¡</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="!isNursingInsurancePeriod()">
                <td>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ä»¥å¤–ï¼‰ï¼ˆå…¨é¡ï¼‰</td>
                <td>{{ calculationResult.ippanFull | number }}å††</td>
              </tr>
              <tr *ngIf="!isNursingInsurancePeriod()">
                <td>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ä»¥å¤–ï¼‰ï¼ˆåŠé¡ï¼‰</td>
                <td>{{ displayIppanHalf | number }}å††</td>
              </tr>
              <tr *ngIf="isNursingInsurancePeriod()">
                <td>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ï¼‰ï¼ˆå…¨é¡ï¼‰</td>
                <td>{{ selectedGradeInfo?.tokutei?.full | number }}å††</td>
              </tr>
              <tr *ngIf="isNursingInsurancePeriod()">
                <td>å¥åº·ä¿é™ºæ–™ï¼ˆ2å·ï¼‰ï¼ˆåŠé¡ï¼‰</td>
                <td>{{ displayTokuteiHalf | number }}å††</td>
              </tr>
              <tr>
                <td>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</td>
                <td>{{ selectedGradeInfo?.kousei?.full | number }}å††</td>
              </tr>
              <tr>
                <td>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</td>
                <td>{{ displayKouseiHalf | number }}å††</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'ratio'">
      <h2>è² æ‹…æ¯”ç‡</h2>
      <div class="section burden-ratio-section">
        <div class="form-group">
          <label for="department-ratio">äº‹æ¥­æ‰€ï¼ˆéƒ¨ç½²ï¼‰</label>
          <select id="department-ratio" [(ngModel)]="selectedDepartmentId" name="department-ratio" (change)="onDepartmentChange()">
            <option value="">å…¨ã¦ã®äº‹æ¥­æ‰€</option>
            <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="yearSelect-ratio">å¯¾è±¡å¹´åº¦</label>
          <select id="yearSelect-ratio" [(ngModel)]="selectedYear" name="yearSelect-ratio">
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>
        <div class="form-group">
          <label for="monthSelect-ratio">å¯¾è±¡æœˆ</label>
          <select id="monthSelect-ratio" [(ngModel)]="selectedMonth" name="monthSelect-ratio">
            <option *ngFor="let m of monthOptions" [value]="m">{{ m }}æœˆ</option>
          </select>
        </div>
        <div class="table-responsive" *ngIf="employeePremiumSummaries.length > 0">
          <div style="margin-bottom: 1.5rem;">
            <div class="burden-summary-cards" style="display: flex; gap: 1.5rem; justify-content: center;">
              <div style="background: #e3f2fd; color: #1976d2; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">ä¼šç¤¾è² æ‹…åˆè¨ˆ</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalCompanyBurden | number }}
                  <span *ngIf="totalCompanyBurdenHasFraction" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalCompanyBurdenFloor | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <div style="background: #fff3e0; color: #fb8c00; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(251, 140, 0, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">å¾“æ¥­å“¡è² æ‹…åˆè¨ˆ</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalEmployeeBurden | number }}
                  <span *ngIf="totalEmployeeBurdenHasFraction" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalEmployeeBurdenFloor | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
              <div style="background: #e8f5e9; color: #388e3c; border-radius: 1.2em; padding: 1.2em 2.2em; min-width: 200px; box-shadow: 0 2px 8px rgba(56, 142, 60, 0.08); text-align: center;">
                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em;">ç·åˆè¨ˆ</div>
                <div style="font-size: 2em; font-weight: bold;">{{ totalBurden | number }}
                  <span *ngIf="totalBurdenHasFraction" style="font-size: 0.7em; color: #888;">ï¼ˆ{{ totalBurdenFloor | number }}ï¼‰</span>
                  <span style="font-size: 0.7em;">å††</span>
                </div>
              </div>
            </div>
            <div style="text-align: center; margin-top: 2.5rem;">
              <button type="button" (click)="saveBurdenRatio()" style="background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #fff; font-weight: bold; font-size: 1.1em; border-radius: 2em; padding: 1em 2.5em; box-shadow: 0 2px 8px rgba(56, 142, 60, 0.12); border: none; outline: none; cursor: pointer; transition: background 0.2s;">
                <mat-icon>save</mat-icon>
                è² æ‹…æ¯”ç‡é›†è¨ˆã‚’ä¿å­˜
              </button>
            </div>
          </div>
          <table class="premium-table">
            <thead>
              <tr>
                <th>æ°å</th>
                <th>å¥åº·ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                <th>å¥åº·ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå¾“æ¥­å“¡è² æ‹…ï¼‰</th>
                <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆä¼šç¤¾è² æ‹…ï¼‰</th>
                <th>å¾“æ¥­å“¡è² æ‹…åˆè¨ˆ</th>
                <th>ä¼šç¤¾è² æ‹…åˆè¨ˆ</th>
                <th>ç·åˆè¨ˆ</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of employeePremiumSummaries">
                <td>{{ row.name }}</td>
                <td>{{ row.ippanEmployee | number }}</td>
                <td>{{ row.ippanCompany | number }}</td>
                <td>{{ row.kouseiEmployee | number }}</td>
                <td>{{ row.kouseiCompany | number }}</td>
                <td>{{ row.totalEmployee | number }}</td>
                <td>{{ row.totalCompany | number }}</td>
                <td>{{ row.total | number }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'master'">
      <h2>ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div class="section">
        <p>ãƒã‚¹ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã«ãƒã‚¹ã‚¿ç·¨é›†UIç­‰ã‚’è¿½åŠ ï¼‰</p>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'history'">
      <h2>å±¥æ­´é–²è¦§</h2>
      <div class="section">
        <p>å±¥æ­´é–²è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã«å±¥æ­´ä¸€è¦§ç­‰ã‚’è¿½åŠ ï¼‰</p>
      </div>
    </ng-container>

    <ng-container *ngIf="selectedTab === 'table'">
      <h2>ä¿é™ºæ–™è¡¨ç®¡ç†</h2>
      <!-- Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ä¿é™ºæ–™è¡¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="importYear" class="form-label">å¹´åº¦</label>
            <select id="importYear" class="form-select" [(ngModel)]="selectedYear">
              <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="excelFile" class="form-label">å”ä¼šã‘ã‚“ã½Excelãƒ•ã‚¡ã‚¤ãƒ«</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" (change)="onFileInputChange($event)" [disabled]="isImporting">
          </div>
          <div class="mb-3" *ngIf="sheetNames.length > 0">
            <label for="sheetSelect" class="form-label">ã‚·ãƒ¼ãƒˆé¸æŠï¼ˆéƒ½é“åºœçœŒï¼‰</label>
            <select id="sheetSelect" class="form-select" [(ngModel)]="selectedSheetName">
              <option *ngFor="let name of sheetNames" [value]="name">{{ name }}</option>
            </select>
          </div>
          <div class="mb-3">
            <button class="btn btn-primary" (click)="onImportClick()" [disabled]="!selectedFile || !selectedSheetName || isImporting">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </div>
          <div *ngIf="importError" class="alert alert-danger">
            {{ importError }}
          </div>
          <div *ngIf="isImporting" class="alert alert-info">
            ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...
          </div>
        </div>
      </div>

      <!-- ä¿é™ºæ–™è¡¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ä¿é™ºæ–™è¡¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
        </div>
        <div class="card-body">
          <button class="btn btn-primary" (click)="exportToExcel()" [disabled]="!selectedPrefectureId">
            ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
        </div>
      </div>

      <!-- ä¿é™ºæ–™è¡¨è¡¨ç¤º -->
      <div class="card" *ngIf="premiums">
        <div class="card-header">
          <h5 class="mb-0">ä¿é™ºæ–™è¡¨</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="premium-table" *ngIf="premiums">
              <thead>
                <tr>
                  <th>ç­‰ç´š</th>
                  <th>æ¨™æº–å ±é…¬æœˆé¡</th>
                  <th>å ±é…¬æœˆé¡ä¸‹é™</th>
                  <th>å ±é…¬æœˆé¡ä¸Šé™</th>
                  <th>ä¸€èˆ¬ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
                  <th>ä¸€èˆ¬ä¿é™ºæ–™ï¼ˆæŠ˜åŠé¡ï¼‰</th>
                  <th>2å·ä¿é™ºè€…ï¼ˆå…¨é¡ï¼‰</th>
                  <th>2å·ä¿é™ºè€…ï¼ˆæŠ˜åŠé¡ï¼‰</th>
                  <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
                  <th>åšç”Ÿå¹´é‡‘ä¿é™ºæ–™ï¼ˆåŠé¡ï¼‰</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let grade of premiums | keyvalue : sortByGrade">
                  <td>{{ grade.key }}</td>
                  <td>{{ grade.value.standardSalary | number }}</td>
                  <td>{{ grade.value.salaryMin | number }}</td>
                  <td>{{ grade.value.salaryMax | number }}</td>
                  <td>{{ grade.value.ippan?.full | number }}</td>
                  <td>{{ grade.value.ippan?.half | number }}</td>
                  <td>{{ grade.value.tokutei?.full | number }}</td>
                  <td>{{ grade.value.tokutei?.half | number }}</td>
                  <td>{{ grade.value.kousei?.full | number }}</td>
                  <td>{{ grade.value.kousei?.half | number }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>
