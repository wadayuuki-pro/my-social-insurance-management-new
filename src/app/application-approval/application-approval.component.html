<div class="application-approval-container">
  <h2><span style="color:#1976d2;">📝</span> 申請・承認ページ</h2>

  <div class="dashboard-user-info" style="position: absolute; top: 1.2rem; right: 2.5rem; background: #e3f2fd; color: #1976d2; border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);">
    <ng-container *ngIf="isAuthReady$ | async as isReady">
      <ng-container *ngIf="isReady; else loading">
        <ng-container *ngIf="employeeInfo$ | async as info; else notLoggedIn">
          <span *ngIf="info; else notLoggedIn">
            ログイン中：会社ID:{{ info.company_id }}／社員ID:{{ info.employee_code }}／氏名:{{ info.name }}
          </span>
        </ng-container>
        <ng-template #notLoggedIn>
          <ng-container *ngIf="user$ | async as user">
            <span *ngIf="user?.email">ログイン中：{{ user.email }}</span>
            <span *ngIf="!user?.email">ログイン情報が取得できません</span>
          </ng-container>
        </ng-template>
      </ng-container>
      <ng-template #loading>
        <span>認証確認中...</span>
      </ng-template>
    </ng-container>
  </div>

  <!-- タブUI -->
  <div class="tab-header">
    <button [class.active]="selectedTab === 'form'" (click)="selectedTab = 'form'">📝 ユーザー申請フォーム</button>
    <button [class.active]="selectedTab === 'approval'" (click)="selectedTab = 'approval'">🔄 承認フロー管理</button>
    <button [class.active]="selectedTab === 'history'" (click)="selectedTab = 'history'">📜 履歴表示・検索</button>
  </div>

  <!-- ユーザー申請フォーム -->
  <div *ngIf="selectedTab === 'form'" class="tab-content">
    <h3>申請フォーム</h3>
    <form class="approval-form" (ngSubmit)="submitApplication()">
      <div class="form-row">
        <label for="requestType">申請種類 <span style="color:#d32f2f;">*</span></label>
        <select id="requestType" name="requestType" [(ngModel)]="requestType" required>
          <option value="">選択してください</option>
          <option>氏名変更</option>
          <option>住所変更</option>
          <option>扶養家族の追加</option>
          <option>扶養家族の削除</option>
          <option>勤務状況変更</option>
          <option>転勤・事業所異動</option>
          <option>育児休業</option>
          <option>産前産後休業</option>
          <option>その他の休職</option>
          <option>復職</option>
          <option>退職</option>
          <option>再雇用</option>
          <option>再入社</option>
          <option>書類確認</option>
        </select>
      </div>

      <!-- 決済ルート作成セクション -->
      <div class="approval-route-section">
        <h4>決済ルート設定</h4>
        
        <!-- 決済ルート作成フォーム -->
        <div class="approval-route-form">
          <div class="form-row">
            <label for="routeName">決済ルート名 <span style="color:#d32f2f;">*</span></label>
            <input type="text" id="routeName" name="routeName" [(ngModel)]="currentRoute.name" placeholder="例：一般申請ルート">
          </div>
          <div class="form-row">
            <label for="applicableFormTypes">対象申請種別 <span style="color:#d32f2f;">*</span></label>
            <select id="applicableFormTypes" name="applicableFormTypes" [(ngModel)]="currentRoute.applicableFormTypes" multiple>
              <option *ngFor="let type of availableFormTypes" [value]="type">{{type}}</option>
            </select>
            <small>CtrlまたはCmdキーで複数選択可</small>
          </div>

          <!-- 決済ステップ一覧 -->
          <div class="approval-steps">
            <div class="steps-header">
              <h5>決済ステップ</h5>
              <button type="button" class="approval-btn add-step" (click)="addApprovalStep()">
                ＋ ステップ追加
              </button>
            </div>

            <div class="step-list">
              <div *ngFor="let step of currentRoute.steps" class="step-item">
                <div class="step-order">{{step.stepOrder}}</div>
                <select [(ngModel)]="step.approverRole" [name]="'stepRole' + step.stepOrder" class="step-role">
                  <option *ngFor="let role of availableRoles" [value]="role">{{role}}</option>
                </select>
                <select [(ngModel)]="step.approverIds" [name]="'stepApprovers' + step.stepOrder" multiple class="step-approvers">
                  <option *ngFor="let emp of employeeList" [value]="emp.employee_code">{{emp.name}}（{{emp.employee_code}}）</option>
                </select>
                <label style="margin-left:0.5em;">
                  <input type="checkbox" [(ngModel)]="step.isFinal" [name]="'stepIsFinal' + step.stepOrder"> 最終承認
                </label>
                <div class="step-actions">
                  <button type="button" class="step-btn move-up" (click)="moveStep(step.stepOrder, 'up')" [disabled]="step.stepOrder === 1">
                    ↑
                  </button>
                  <button type="button" class="step-btn move-down" (click)="moveStep(step.stepOrder, 'down')" [disabled]="step.stepOrder === currentRoute.steps.length">
                    ↓
                  </button>
                  <button type="button" class="step-btn remove" (click)="removeApprovalStep(step.stepOrder)">
                    ×
                  </button>
                </div>
              </div>
            </div>

            <button *ngIf="!editingRouteId" type="button" class="approval-btn save-route" (click)="addApprovalRoute()" [disabled]="!currentRoute.name || currentRoute.steps.length === 0 || !currentRoute.applicableFormTypes.length">
              決済ルートを保存
            </button>
            <div *ngIf="editingRouteId" style="display:flex; gap:1em;">
              <button type="button" class="approval-btn save-route" (click)="updateApprovalRoute()" [disabled]="!currentRoute.name || currentRoute.steps.length === 0 || !currentRoute.applicableFormTypes.length">
                決済ルートを更新
              </button>
              <button type="button" class="approval-btn draft" (click)="cancelEditRoute()">キャンセル</button>
            </div>
          </div>
        </div>

        <!-- 保存済み決済ルート一覧 -->
        <div class="saved-routes" *ngIf="approvalRoutes.length > 0">
          <h5>保存済み決済ルート</h5>
          <div class="route-list">
            <div *ngFor="let route of approvalRoutes" class="route-item">
              <div class="route-info">
                <h6>{{route.name}}</h6>
                <div class="route-steps">
                  <span *ngFor="let step of route.steps; let last = last">
                    {{step.approverRole}}{{step.isFinal ? '（最終）' : ''}}{{!last ? ' → ' : ''}}
                  </span>
                </div>
                <div class="route-types">
                  <span>対象申請種別: {{route.applicableFormTypes.join(', ')}}</span>
                </div>
              </div>
              <div style="display:flex; gap:0.5em;">
                <button type="button" class="approval-btn delete-route" (click)="deleteApprovalRoute(route.id)">
                  削除
                </button>
                <button type="button" class="approval-btn draft" (click)="startEditRoute(route)">
                  編集
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <label>申請タイトル <span style="color:#d32f2f;">*</span></label>
        <input type="text" [(ngModel)]="title" name="title" placeholder="申請のタイトルを入力" required />
      </div>
      <div class="form-row">
        <label>申請内容詳細 <span style="color:#d32f2f;">*</span></label>
        <textarea rows="3" [(ngModel)]="detail" name="detail" placeholder="申請内容の詳細を入力" required></textarea>
      </div>
      <div class="form-row">
        <label style="display:flex; align-items:center; gap:0.5em;">
          <input type="checkbox" [(ngModel)]="isImportant" name="isImportant" />
          重要度が高い申請
        </label>
      </div>
      <div class="form-row">
        <label>添付ファイル</label>
        <input type="file" multiple />
      </div>
      <div class="form-row" style="display:flex; gap:1em;">
        <button type="button" class="approval-btn draft">下書き保存</button>
        <button type="submit" class="approval-btn submit">送信</button>
      </div>
    </form>
  </div>

  <!-- 承認フロー管理 -->
  <div *ngIf="selectedTab === 'approval'" class="tab-content">
    <h3>承認フロー管理</h3>
    <div class="approval-list-container">
      <table class="approval-table">
        <thead>
          <tr>
            <th style="width: 15%">申請者名</th>
            <th style="width: 15%">申請種類</th>
            <th style="width: 20%">申請日</th>
            <th style="width: 20%">ステータス</th>
            <th style="width: 10%">コメント</th>
            <th style="width: 20%">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>山田 太郎</td>
            <td>住所変更</td>
            <td>2024/06/01</td>
            <td><span class="status status-pending">申請中</span></td>
            <td>-</td>
            <td>
              <div class="action-buttons">
                <button class="approval-btn approve">承認</button>
                <button class="approval-btn reject">却下</button>
                <button class="approval-btn comment">差戻し</button>
              </div>
            </td>
          </tr>
          <tr>
            <td>佐藤 花子</td>
            <td>扶養異動</td>
            <td>2024/05/28</td>
            <td><span class="status status-approved">承認済み</span></td>
            <td>書類不備なし</td>
            <td>-</td>
          </tr>
          <tr>
            <td>鈴木 一郎</td>
            <td>氏名変更</td>
            <td>2024/05/20</td>
            <td><span class="status status-rejected">却下</span></td>
            <td>証明書類不足</td>
            <td>-</td>
          </tr>
        </tbody>
      </table>
      <div class="approval-comment-box">
        <h4>差戻しコメント入力</h4>
        <textarea rows="2" placeholder="差戻し理由や修正点を入力"></textarea>
        <button class="approval-btn comment">コメント送信</button>
      </div>
    </div>
  </div>

  <!-- 履歴表示・検索 -->
  <div *ngIf="selectedTab === 'history'" class="tab-content">
    <h3>申請履歴・検索</h3>
    <div class="history-filter-row">
      <label>ステータス:
        <select>
          <option>すべて</option>
          <option>申請中</option>
          <option>承認済み</option>
          <option>差戻し</option>
          <option>却下</option>
        </select>
      </label>
      <label>申請者:
        <input type="text" placeholder="氏名で検索" />
      </label>
      <button class="approval-btn search">検索</button>
    </div>
    <table class="approval-table">
      <thead>
        <tr>
          <th>申請者名</th>
          <th>申請種類</th>
          <th>申請日</th>
          <th>ステータス</th>
          <th>承認・差戻しコメント</th>
          <th>担当者</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>山田 太郎</td>
          <td>住所変更</td>
          <td>2024/06/01</td>
          <td><span class="status status-pending">申請中</span></td>
          <td>-</td>
          <td>田中 課長</td>
        </tr>
        <tr>
          <td>佐藤 花子</td>
          <td>扶養異動</td>
          <td>2024/05/28</td>
          <td><span class="status status-approved">承認済み</span></td>
          <td>書類不備なし</td>
          <td>鈴木 部長</td>
        </tr>
        <tr>
          <td>鈴木 一郎</td>
          <td>氏名変更</td>
          <td>2024/05/20</td>
          <td><span class="status status-rejected">却下</span></td>
          <td>証明書類不足</td>
          <td>田中 課長</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
