<div class="application-approval-container">
  <h2><span style="color:#1976d2;">ğŸ“</span> ç”³è«‹ãƒ»æ‰¿èªãƒšãƒ¼ã‚¸</h2>

  <div class="dashboard-user-info" style="position: absolute; top: 1.2rem; right: 2.5rem; background: #e3f2fd; color: #1976d2; border-radius: 8px; padding: 0.7rem 1.2rem; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);">
    <ng-container *ngIf="isAuthReady$ | async as isReady">
      <ng-container *ngIf="isReady; else loading">
        <ng-container *ngIf="employeeInfo$ | async as info; else notLoggedIn">
          <span *ngIf="info; else notLoggedIn">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šä¼šç¤¾ID:{{ info.company_id }}ï¼ç¤¾å“¡ID:{{ info.employee_code }}ï¼æ°å:{{ info.name }}
          </span>
        </ng-container>
        <ng-template #notLoggedIn>
          <ng-container *ngIf="user$ | async as user">
            <span *ngIf="user?.email">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š{{ user.email }}</span>
            <span *ngIf="!user?.email">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</span>
          </ng-container>
        </ng-template>
      </ng-container>
      <ng-template #loading>
        <span>èªè¨¼ç¢ºèªä¸­...</span>
      </ng-template>
    </ng-container>
  </div>

  <!-- ã‚¿ãƒ–UI -->
  <div class="tab-header">
    <button [class.active]="selectedTab === 'form'" (click)="selectedTab = 'form'">ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </button>
    <button [class.active]="selectedTab === 'approval'" (click)="selectedTab = 'approval'">ğŸ”„ æ‰¿èªãƒ•ãƒ­ãƒ¼ç®¡ç†</button>
    <button [class.active]="selectedTab === 'history'" (click)="selectedTab = 'history'">ğŸ“œ å±¥æ­´è¡¨ç¤ºãƒ»æ¤œç´¢</button>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div *ngIf="selectedTab === 'form'" class="tab-content">
    <h3>ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </h3>
    <form class="approval-form" (ngSubmit)="submitApplication()">
      <div class="form-row">
        <label for="requestType">ç”³è«‹ç¨®é¡ <span style="color:#d32f2f;">*</span></label>
        <select id="requestType" name="requestType" [(ngModel)]="requestType" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option>æ°åå¤‰æ›´</option>
          <option>ä½æ‰€å¤‰æ›´</option>
          <option>æ‰¶é¤Šå®¶æ—ã®è¿½åŠ </option>
          <option>æ‰¶é¤Šå®¶æ—ã®å‰Šé™¤</option>
          <option>å‹¤å‹™çŠ¶æ³å¤‰æ›´</option>
          <option>è»¢å‹¤ãƒ»äº‹æ¥­æ‰€ç•°å‹•</option>
          <option>è‚²å…ä¼‘æ¥­</option>
          <option>ç”£å‰ç”£å¾Œä¼‘æ¥­</option>
          <option>ãã®ä»–ã®ä¼‘è·</option>
          <option>å¾©è·</option>
          <option>é€€è·</option>
          <option>å†é›‡ç”¨</option>
          <option>å†å…¥ç¤¾</option>
          <option>æ›¸é¡ç¢ºèª</option>
        </select>
      </div>

      <!-- æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="approval-route-section">
        <h4>æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆè¨­å®š</h4>
        
        <!-- æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="approval-route-form">
          <div class="form-row">
            <label for="routeName">æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆå <span style="color:#d32f2f;">*</span></label>
            <input type="text" id="routeName" name="routeName" [(ngModel)]="currentRoute.name" placeholder="ä¾‹ï¼šä¸€èˆ¬ç”³è«‹ãƒ«ãƒ¼ãƒˆ">
          </div>
          <div class="form-row">
            <label for="applicableFormTypes">å¯¾è±¡ç”³è«‹ç¨®åˆ¥ <span style="color:#d32f2f;">*</span></label>
            <select id="applicableFormTypes" name="applicableFormTypes" [(ngModel)]="currentRoute.applicableFormTypes" multiple>
              <option *ngFor="let type of availableFormTypes" [value]="type">{{type}}</option>
            </select>
            <small>Ctrlã¾ãŸã¯Cmdã‚­ãƒ¼ã§è¤‡æ•°é¸æŠå¯</small>
          </div>

          <!-- æ±ºæ¸ˆã‚¹ãƒ†ãƒƒãƒ—ä¸€è¦§ -->
          <div class="approval-steps">
            <div class="steps-header">
              <h5>æ±ºæ¸ˆã‚¹ãƒ†ãƒƒãƒ—</h5>
              <button type="button" class="approval-btn add-step" (click)="addApprovalStep()">
                ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
              </button>
            </div>

            <div class="step-list">
              <div *ngFor="let step of currentRoute.steps" class="step-item">
                <div class="step-order">{{step.stepOrder}}</div>
                <select [(ngModel)]="step.approverRole" [name]="'stepRole' + step.stepOrder" class="step-role">
                  <option *ngFor="let role of availableRoles" [value]="role">{{role}}</option>
                </select>
                <select [(ngModel)]="step.approverIds" [name]="'stepApprovers' + step.stepOrder" multiple class="step-approvers">
                  <option *ngFor="let emp of employeeList" [value]="emp.employee_code">{{emp.name}}ï¼ˆ{{emp.employee_code}}ï¼‰</option>
                </select>
                <label style="margin-left:0.5em;">
                  <input type="checkbox" [(ngModel)]="step.isFinal" [name]="'stepIsFinal' + step.stepOrder"> æœ€çµ‚æ‰¿èª
                </label>
                <div class="step-actions">
                  <button type="button" class="step-btn move-up" (click)="moveStep(step.stepOrder, 'up')" [disabled]="step.stepOrder === 1">
                    â†‘
                  </button>
                  <button type="button" class="step-btn move-down" (click)="moveStep(step.stepOrder, 'down')" [disabled]="step.stepOrder === currentRoute.steps.length">
                    â†“
                  </button>
                  <button type="button" class="step-btn remove" (click)="removeApprovalStep(step.stepOrder)">
                    Ã—
                  </button>
                </div>
              </div>
            </div>

            <button *ngIf="!editingRouteId" type="button" class="approval-btn save-route" (click)="addApprovalRoute()" [disabled]="!currentRoute.name || currentRoute.steps.length === 0 || !currentRoute.applicableFormTypes.length">
              æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜
            </button>
            <div *ngIf="editingRouteId" style="display:flex; gap:1em;">
              <button type="button" class="approval-btn save-route" (click)="updateApprovalRoute()" [disabled]="!currentRoute.name || currentRoute.steps.length === 0 || !currentRoute.applicableFormTypes.length">
                æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆã‚’æ›´æ–°
              </button>
              <button type="button" class="approval-btn draft" (click)="cancelEditRoute()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>

        <!-- ä¿å­˜æ¸ˆã¿æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆä¸€è¦§ -->
        <div class="saved-routes" *ngIf="approvalRoutes.length > 0">
          <h5>ä¿å­˜æ¸ˆã¿æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆ</h5>
          <div class="route-list">
            <div *ngFor="let route of approvalRoutes" class="route-item">
              <div class="route-info">
                <h6>{{route.name}}</h6>
                <div class="route-steps">
                  <span *ngFor="let step of route.steps; let last = last">
                    {{step.approverRole}}{{step.isFinal ? 'ï¼ˆæœ€çµ‚ï¼‰' : ''}}{{!last ? ' â†’ ' : ''}}
                  </span>
                </div>
                <div class="route-types">
                  <span>å¯¾è±¡ç”³è«‹ç¨®åˆ¥: {{route.applicableFormTypes.join(', ')}}</span>
                </div>
              </div>
              <div style="display:flex; gap:0.5em;">
                <button type="button" class="approval-btn delete-route" (click)="deleteApprovalRoute(route.id)">
                  å‰Šé™¤
                </button>
                <button type="button" class="approval-btn draft" (click)="startEditRoute(route)">
                  ç·¨é›†
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <label for="approvalRoute">æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆ <span style="color:#d32f2f;">*</span></label>
        <select id="approvalRoute" name="approvalRoute" [(ngModel)]="selectedApprovalRouteId" required [disabled]="filteredApprovalRoutes.length === 0">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option *ngFor="let route of filteredApprovalRoutes" [value]="route.id">
            {{ route.name }}ï¼ˆ{{ route.applicableFormTypes.join(', ') }}ï¼‰
          </option>
        </select>
        <small *ngIf="filteredApprovalRoutes.length === 0" style="color:#d32f2f;">ã“ã®ç”³è«‹ç¨®é¡ã«åˆ©ç”¨ã§ãã‚‹æ±ºæ¸ˆãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</small>
      </div>

      <div class="form-row">
        <label>ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ« <span style="color:#d32f2f;">*</span></label>
        <input type="text" [(ngModel)]="title" name="title" placeholder="ç”³è«‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required />
      </div>
      <div class="form-row">
        <label>ç”³è«‹å†…å®¹è©³ç´° <span style="color:#d32f2f;">*</span></label>
        <textarea rows="3" [(ngModel)]="detail" name="detail" placeholder="ç”³è«‹å†…å®¹ã®è©³ç´°ã‚’å…¥åŠ›" required></textarea>
      </div>
      <div class="form-row">
        <label style="display:flex; align-items:center; gap:0.5em;">
          <input type="checkbox" [(ngModel)]="isImportant" name="isImportant" />
          é‡è¦åº¦ãŒé«˜ã„ç”³è«‹
        </label>
      </div>
      <div class="form-row">
        <label>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <input type="file" multiple (change)="onFileSelected($event)" />
        <div *ngIf="uploading" style="color:#1976d2; font-size:0.95em; margin-top:0.5em;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
        <div *ngIf="attachments.length > 0" class="uploaded-files" style="margin-top:0.5em;">
          <span style="font-size:0.95em; color:#333;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«:</span>
          <ul class="attachment-gallery">
            <li *ngFor="let url of attachments" class="attachment-item">
              <a [href]="url" target="_blank">
                <ng-container *ngIf="isImageFile(url); else fileIcon">
                  <img [src]="url" alt="æ·»ä»˜ç”»åƒ" class="attachment-thumb" />
                  <div class="attachment-label">å†™çœŸ</div>
                </ng-container>
                <ng-template #fileIcon>
                  <div class="attachment-fileicon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                      <path d="M17 7V17C17 19.2091 15.2091 21 13 21C10.7909 21 9 19.2091 9 17V7C9 5.89543 9.89543 5 11 5C12.1046 5 13 5.89543 13 7V17" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="attachment-label">ãƒ•ã‚¡ã‚¤ãƒ«</div>
                  <div class="attachment-filename">{{ getFileName(url) }}</div>
                </ng-template>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="form-row" style="display:flex; gap:1em;">
        <button type="button" class="approval-btn draft" (click)="saveDraft()">ä¸‹æ›¸ãä¿å­˜</button>
        <button type="submit" class="approval-btn submit">é€ä¿¡</button>
      </div>
    </form>

    <div *ngIf="drafts.length > 0" class="draft-list" style="margin-top:2em;">
      <h4 style="color:#1976d2; font-size:1.1em; margin-bottom:0.7em;">ä¸‹æ›¸ãä¸€è¦§</h4>
      <table style="width:100%; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(25,118,210,0.06);">
        <thead>
          <tr style="background:#f5f5f5;">
            <th style="padding:0.6em;">ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th style="padding:0.6em;">ç”³è«‹ç¨®åˆ¥</th>
            <th style="padding:0.6em;">ä½œæˆæ—¥</th>
            <th style="padding:0.6em;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let draft of drafts">
            <td style="padding:0.6em;">{{ draft.title }}</td>
            <td style="padding:0.6em;">{{ draft.type }}</td>
            <td style="padding:0.6em;">{{ draft.createdAt?.toDate ? (draft.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : (draft.createdAt | date:'yyyy/MM/dd HH:mm') }}</td>
            <td style="padding:0.6em;">
              <button type="button" class="approval-btn draft" (click)="editDraft(draft)">ç·¨é›†</button>
              <button type="button" class="approval-btn delete-route" (click)="deleteDraft(draft.id)">å‰Šé™¤</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- æ‰¿èªãƒ•ãƒ­ãƒ¼ç®¡ç† -->
  <div *ngIf="selectedTab === 'approval'" class="tab-content">
    <h3>æ‰¿èªãƒ•ãƒ­ãƒ¼ç®¡ç†</h3>

    <!-- è‡ªåˆ†ãŒæ‰¿èªå¾…ã¡ã®ç”³è«‹ä¸€è¦§ -->
    <div *ngIf="myApprovalList.length > 0" class="my-approval-list" style="margin-bottom:2em;">
      <h4 style="color:#1976d2; font-size:1.1em; margin-bottom:0.7em;">è‡ªåˆ†ãŒæ‰¿èªå¾…ã¡ã®ç”³è«‹</h4>
      <table class="approval-table">
        <thead>
          <tr>
            <th>ç”³è«‹è€…å</th>
            <th>ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ç”³è«‹ç¨®åˆ¥</th>
            <th>ç”³è«‹æ—¥</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let app of myApprovalList">
            <td>{{ employeeNameMap[app.employeeId] || app.employeeId }}</td>
            <td>{{ app.title }}</td>
            <td>{{ app.type }}</td>
            <td>{{ app.createdAt?.toDate ? (app.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : (app.createdAt | date:'yyyy/MM/dd HH:mm') }}</td>
            <td>
              <button class="approval-btn comment" (click)="openMyApprovalDetail(app)">å†…å®¹ç¢ºèª</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="myApprovalList.length === 0" style="color:#888; margin-top:2em;">
      æ‰¿èªå¾…ã¡ã®ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    </div>
  </div>

  <!-- å±¥æ­´è¡¨ç¤ºãƒ»æ¤œç´¢ -->
  <div *ngIf="selectedTab === 'history'" class="tab-content">
    <h3>ç”³è«‹å±¥æ­´ãƒ»æ¤œç´¢</h3>
    <div *ngIf="myApplicationHistory.length > 0; else noHistory">
      <table class="approval-table">
        <thead>
          <tr>
            <th>ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ç”³è«‹ç¨®åˆ¥</th>
            <th>ç”³è«‹æ—¥</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>æ‰¿èªãƒ«ãƒ¼ãƒˆ</th>
            <th>é€²æ—</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let app of myApplicationHistory">
            <td>{{ app.title }}</td>
            <td>{{ app.type }}</td>
            <td>{{ app.createdAt?.toDate ? (app.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : (app.createdAt | date:'yyyy/MM/dd HH:mm') }}</td>
            <td>
              <span [ngClass]="{
                'status-approved': app.status === 'æ‰¿èªæ¸ˆã¿',
                'status-pending': app.status === 'ç”³è«‹ä¸­',
                'status-rejected': app.status === 'å´ä¸‹'
              }">{{ app.status }}</span>
            </td>
            <td>
              <ng-container *ngFor="let step of getApprovalRouteSteps(app.approvalRouteId); let i = index">
                <span>{{ step.approverRole }}</span><span *ngIf="i < getApprovalRouteSteps(app.approvalRouteId).length - 1">â†’</span>
              </ng-container>
            </td>
            <td>
              <span *ngIf="app.status === 'æ‰¿èªæ¸ˆã¿'">å®Œäº†</span>
              <span *ngIf="app.status === 'å´ä¸‹'">å´ä¸‹</span>
              <span *ngIf="app.status === 'ç”³è«‹ä¸­'">{{ app.currentStep }}/{{ getApprovalRouteSteps(app.approvalRouteId).length || '-' }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noHistory>
      <div style="color:#888; margin-top:2em;">ç”³è«‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </ng-template>
  </div>
</div>

<!-- ç”³è«‹å†…å®¹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div *ngIf="selectedApprovalDetail" class="approval-detail-modal" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:1000; display:flex; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; box-shadow:0 4px 24px rgba(25,118,210,0.18); padding:2em; min-width:340px; max-width:95vw; max-height:90vh; overflow:auto; position:relative;">
    <button (click)="closeApprovalDetail()" style="position:absolute; top:1em; right:1em; background:none; border:none; font-size:1.5em; color:#1976d2; cursor:pointer;">Ã—</button>
    <h4 style="color:#1976d2; font-size:1.2em; margin-bottom:0.7em;">ç”³è«‹å†…å®¹è©³ç´°</h4>
    <div style="margin-bottom:0.7em;"><b>ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«ï¼š</b>{{ selectedApprovalDetail.title }}</div>
    <div style="margin-bottom:0.7em;"><b>ç”³è«‹è€…ï¼š</b>{{ employeeNameMap[selectedApprovalDetail.employeeId] || selectedApprovalDetail.employeeId }}</div>
    <div style="margin-bottom:0.7em;"><b>ç”³è«‹ç¨®åˆ¥ï¼š</b>{{ selectedApprovalDetail.type }}</div>
    <div style="margin-bottom:0.7em;"><b>ç”³è«‹æ—¥ï¼š</b>{{ selectedApprovalDetail.createdAt?.toDate ? (selectedApprovalDetail.createdAt.toDate() | date:'yyyy/MM/dd HH:mm') : (selectedApprovalDetail.createdAt | date:'yyyy/MM/dd HH:mm') }}</div>
    <div style="margin-bottom:0.7em;"><b>é‡è¦åº¦ï¼š</b><span *ngIf="selectedApprovalDetail.isImportant" style="color:#d32f2f; font-weight:bold;">é«˜</span><span *ngIf="!selectedApprovalDetail.isImportant">é€šå¸¸</span></div>
    <div style="margin-bottom:0.7em;"><b>ç”³è«‹å†…å®¹è©³ç´°ï¼š</b><br>{{ selectedApprovalDetail.description }}</div>
    <div *ngIf="selectedApprovalDetail.attachments && selectedApprovalDetail.attachments.length > 0" style="margin-bottom:0.7em;">
      <b>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼š</b>
      <ul style="padding-left:1.2em;">
        <li *ngFor="let url of selectedApprovalDetail.attachments">
          <a [href]="url" target="_blank">{{ url }}</a>
        </li>
      </ul>
    </div>
    <div style="display:flex; gap:1em; margin-top:1.5em;">
      <button class="approval-btn approve" (click)="approveApplication(selectedApprovalDetail)">æ‰¿èª</button>
      <button class="approval-btn reject">å´ä¸‹</button>
    </div>
  </div>
</div>
