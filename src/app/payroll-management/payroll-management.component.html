<div class="payroll-management-container">
  <h1>çµ¦ä¸æƒ…å ±ç®¡ç†</h1>
  <div class="tab-header">
    <button [class.active]="activeTab === 'salary'" (click)="onTabChange('salary')">ğŸ’¼ æœˆé¡çµ¦ä¸ãƒ»æ‰‹å½“ãƒ»è³ä¸ç®¡ç†</button>
    <button [class.active]="activeTab === 'auto-judge'" (click)="onTabChange('auto-judge')">ğŸ”„ å ±é…¬æœˆé¡å¤‰æ›´è‡ªå‹•åˆ¤å®š</button>
    <button [class.active]="activeTab === 'history'" (click)="onTabChange('history')">ğŸ“œ çµ¦ä¸æƒ…å ±å±¥æ­´ç®¡ç†</button>
    <button [class.active]="activeTab === 'insurance'" (click)="onTabChange('insurance')">ğŸ¥ ä¿é™ºæ–™è¡¨ç®¡ç†</button>
    <button [class.active]="activeTab === 'csv'" (click)="onTabChange('csv')">ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>

  <!-- æœˆé¡çµ¦ä¸ãƒ»æ‰‹å½“ãƒ»è³ä¸ç®¡ç† -->
  <div *ngIf="activeTab === 'salary'" class="tab-content">
    <h2>æœˆé¡çµ¦ä¸ãƒ»æ‰‹å½“ãƒ»è³ä¸ç®¡ç†</h2>
    <div class="salary-form">
      <h3>çµ¦ä¸æ˜ç´°ç™»éŒ²</h3>
      <div class="form-group">
        <label for="employeeSearch">å¾“æ¥­å“¡æ¤œç´¢ï¼ˆæ°åãƒ»IDï¼‰</label>
        <input type="text" id="employeeSearch" placeholder="æ°åãƒ»IDã§æ¤œç´¢" [(ngModel)]="searchText" (ngModelChange)="filterEmployees()" name="employeeSearch" />
      </div>
      <form (ngSubmit)="registerSalary($event)">
        <div class="form-group">
          <label for="employee">å¾“æ¥­å“¡</label>
          <select id="employee" [(ngModel)]="selectedEmployeeId" name="employee" (change)="onEmployeeSelect()" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let emp of filteredEmployees" [value]="emp.id">
              {{emp.last_name_kanji}} {{emp.first_name_kanji}} ({{emp.employee_code}})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="yearMonth">å¯¾è±¡å¹´æœˆ</label>
          <input type="month" id="yearMonth" name="yearMonth" required>
        </div>

        <div class="salary-details">
          <h4>æ˜ç´°</h4>
          <div class="detail-actions">
            <button type="button" (click)="addSalaryDetail()">æ˜ç´°è¿½åŠ </button>
            <button type="button" (click)="openCustomAllowanceModal()">æ‰‹å½“åŒºåˆ†ç®¡ç†</button>
          </div>
          <div class="detail-list">
            <div class="detail-item" *ngFor="let detail of salaryDetails; let i = index">
              <select [(ngModel)]="detail.type" name="type{{i}}" (change)="onDetailChange()">
                <option *ngFor="let type of salaryTypes" [value]="type.value">{{type.label}}</option>
              </select>
              <input type="number" [(ngModel)]="detail.amount" name="amount{{i}}" (input)="onDetailChange()" placeholder="é‡‘é¡">
              <input type="text" [(ngModel)]="detail.note" name="note{{i}}" placeholder="å‚™è€ƒ">
              <button type="button" (click)="removeSalaryDetail(i)">å‰Šé™¤</button>
            </div>
          </div>
        </div>

        <div class="totals">
          <div class="total-item">
            <span>ç·æ”¯çµ¦é¡:</span>
            <span>{{formatAmount(totalAmount)}}å††</span>
          </div>
          <div class="total-item">
            <span>èª²ç¨å¯¾è±¡é¡:</span>
            <span>{{formatAmount(taxableAmount)}}å††</span>
          </div>
          <div class="total-item">
            <span>ç¤¾ä¼šä¿é™ºæ–™æ§é™¤é¡:</span>
            <span>{{formatAmount(socialInsuranceDeduction)}}å††</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit">ç™»éŒ²</button>
          <button type="button" (click)="clearForm()">ã‚¯ãƒªã‚¢</button>
        </div>
      </form>
    </div>
    <div class="section">
      <h3>ç™»éŒ²æ¸ˆã¿çµ¦ä¸æ˜ç´°ä¸€è¦§</h3>
      <div class="table-container">
        <table class="payroll-table" style="min-width: 1100px;">
          <thead>
            <tr>
              <th>å¹´æœˆ</th>
              <th>åŸºæœ¬çµ¦</th>
              <th>æ®‹æ¥­æ‰‹å½“</th>
              <th>é€šå‹¤æ‰‹å½“</th>
              <th>ãã®ä»–æ‰‹å½“</th>
              <th>ç·æ”¯çµ¦é¡</th>
              <th>èª²ç¨å¯¾è±¡é¡</th>
              <th>ç¤¾ä¼šä¿é™ºæ–™</th>
              <th>ç™»éŒ²æ—¥æ™‚</th>
              <th class="action-column">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let salary of registeredSalaries">
              <td>{{ salary.year_month }}</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'base')) }}å††</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'overtime')) }}å††</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'commuting')) }}å††</td>
              <td>{{ formatAmount(getOtherAllowances(salary)) }}å††</td>
              <td>{{ formatAmount(salary.total_amount) }}å††</td>
              <td>{{ formatAmount(salary.taxable_amount) }}å††</td>
              <td>{{ formatAmount(salary.social_insurance_deduction) }}å††</td>
              <td>{{ formatDate(salary.created_at) }}</td>
              <td class="action-column">
                <button type="button" (click)="editSalary(salary)">ç·¨é›†</button>
                <button type="button" (click)="deleteSalary(salary)">å‰Šé™¤</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- å ±é…¬æœˆé¡å¤‰æ›´è‡ªå‹•åˆ¤å®š -->
  <div *ngIf="activeTab === 'auto-judge'" class="tab-content">
    <h2>å ±é…¬æœˆé¡å¤‰æ›´è‡ªå‹•åˆ¤å®š</h2>
    <div class="section">
      
      <div class="alert" *ngIf="autoJudgeAlert">{{ autoJudgeAlert }}</div>
      <div class="alert" *ngIf="!autoJudgeAlert && autoJudgeSalaries.length >= 6">2ç­‰ç´šä»¥ä¸Šã®å¤‰å‹•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>
      <div class="alert" *ngIf="autoJudgeSalaries.length < 6">åˆ¤å®šã«ã¯ç›´è¿‘6ãƒ¶æœˆä»¥ä¸Šã®çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚</div>

      <!-- å…¨å¾“æ¥­å“¡åˆ¤å®šä¸€è¦§ -->
      <div style="margin-top:2.5em;">
        <button (click)="loadSalarySummaries()" [disabled]="isSummaryLoading">
          å…¨å¾“æ¥­å“¡åˆ¤å®šä¸€è¦§ã‚’è¡¨ç¤º
        </button>
        <div *ngIf="isSummaryLoading" style="margin:1em 0; color:#888;">é›†è¨ˆä¸­...</div>
        <div class="table-container" *ngIf="salarySummaries.length > 0">
          <table class="payroll-table" style="min-width: 700px;">
            <thead>
              <tr>
                <th>æ°åï¼ˆIDï¼‰</th>
                <th>ç›´è¿‘3ãƒ¶æœˆå¹³å‡</th>
                <th>å‰3ãƒ¶æœˆå¹³å‡</th>
                <th>å¢—æ¸›ç‡</th>
                <th>ç›´è¿‘3ãƒ¶æœˆç­‰ç´š</th>
                <th>å‰3ãƒ¶æœˆç­‰ç´š</th>
                <th>åˆ¤å®šçµæœ</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let s of salarySummaries">
                <td>{{ s.name }}</td>
                <td>{{ s.avgLast3 | number:'1.0-0' }}å††</td>
                <td>{{ s.avgPrev3 | number:'1.0-0' }}å††</td>
                <td>{{ s.diffRate | percent:'1.1-2' }}</td>
                <td>{{ s.gradeLast3 !== null ? s.gradeLast3 : '-' }}</td>
                <td>{{ s.gradePrev3 !== null ? s.gradePrev3 : '-' }}</td>
                <td>{{ s.result }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="!isSummaryLoading && salarySummaries.length === 0" style="margin:1em 0; color:#888;">è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </div>
  </div>

  <!-- çµ¦ä¸æƒ…å ±å±¥æ­´ç®¡ç† -->
  <div *ngIf="activeTab === 'history'" class="tab-content">
    <h2>çµ¦ä¸æƒ…å ±å±¥æ­´ç®¡ç†</h2>
    <div class="section">
      <div *ngIf="isHistoryLoading" style="margin:1em 0; color:#888;">å±¥æ­´ã‚’å–å¾—ä¸­...</div>
      <table class="dummy-table" *ngIf="!isHistoryLoading && salaryHistories.length > 0">
        <thead>
          <tr>
            <th>ç¤¾å“¡ID</th>
            <th>æ°å</th>
            <th>å¯¾è±¡å¹´æœˆ</th>
            <th>æ“ä½œ</th>
            <th>æ“ä½œæ—¥æ™‚</th>
            <th>æ“ä½œãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
            <th>å¤‰æ›´å†…å®¹</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let h of salaryHistories">
            <td>{{ h.employee_id }}</td>
            <td>{{ h.employee_name }}</td>
            <td>{{ h.year_month }}</td>
            <td>{{ h.operation === 'create' ? 'æ–°è¦ä½œæˆ' : 'æ›´æ–°' }}</td>
            <td>{{ h.operated_at | date:'yyyy/MM/dd HH:mm' }}</td>
            <td>{{ h.operator }}</td>
            <td>{{ h.changeMessage }}</td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="!isHistoryLoading && salaryHistories.length === 0" style="margin:1em 0; color:#888;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    </div>
  </div>

  <!-- ä¿é™ºæ–™è¡¨ç®¡ç† -->
  <div *ngIf="activeTab === 'insurance'" class="tab-content">
    <h2>ä¿é™ºæ–™è¡¨ç®¡ç†</h2>
    
    <!-- Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ä¿é™ºæ–™è¡¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="importYear" class="form-label">å¹´åº¦</label>
          <select id="importYear" class="form-select" [(ngModel)]="selectedYear">
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}å¹´åº¦</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="excelFile" class="form-label">å”ä¼šã‘ã‚“ã½Excelãƒ•ã‚¡ã‚¤ãƒ«</label>
          <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" (change)="onFileInputChange($event)" [disabled]="isImporting">
        </div>
        <div class="mb-3" *ngIf="sheetNames.length > 0">
          <label for="sheetSelect" class="form-label">ã‚·ãƒ¼ãƒˆé¸æŠï¼ˆéƒ½é“åºœçœŒï¼‰</label>
          <select id="sheetSelect" class="form-select" [(ngModel)]="selectedSheetName">
            <option *ngFor="let name of sheetNames" [value]="name">{{ name }}</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" (click)="onImportClick()" [disabled]="!selectedFile || !selectedSheetName || isImporting">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <div *ngIf="importError" class="alert alert-danger">
          {{ importError }}
        </div>
        <div *ngIf="isImporting" class="alert alert-info">
          ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...
        </div>
      </div>
    </div>

    <!-- ä¿é™ºæ–™è¡¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ä¿é™ºæ–™è¡¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
      </div>
      <div class="card-body">
        <button class="btn btn-primary" (click)="exportToExcel()" [disabled]="!selectedPrefectureId">
          ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
      </div>
    </div>

    <!-- ä¿é™ºæ–™è¡¨è¡¨ç¤º -->
    <div class="card" *ngIf="premiums">
      <div class="card-header">
        <h5 class="mb-0">ä¿é™ºæ–™è¡¨</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="premium-table" *ngIf="premiums">
            <thead>
              <tr>
                <th>ç­‰ç´š</th>
                <th>æ¨™æº–å ±é…¬æœˆé¡</th>
                <th>å ±é…¬æœˆé¡ä¸‹é™</th>
                <th>å ±é…¬æœˆé¡ä¸Šé™</th>
                <th>ä¸€èˆ¬ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
                <th>ä¸€èˆ¬ä¿é™ºæ–™ï¼ˆæŠ˜åŠé¡ï¼‰</th>
                <th>ç‰¹å®šä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
                <th>ç‰¹å®šä¿é™ºæ–™ï¼ˆæŠ˜åŠé¡ï¼‰</th>
                <th>åŸºæœ¬ä¿é™ºæ–™ï¼ˆå…¨é¡ï¼‰</th>
                <th>åŸºæœ¬ä¿é™ºæ–™ï¼ˆæŠ˜åŠé¡ï¼‰</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let grade of premiums | keyvalue : sortByGrade">
                <td>{{ grade.key }}</td>
                <td>{{ grade.value.standardSalary | number }}</td>
                <td>{{ grade.value.salaryMin | number }}</td>
                <td>{{ grade.value.salaryMax | number }}</td>
                <td>{{ grade.value.ippan.full | number }}</td>
                <td>{{ grade.value.ippan.half | number }}</td>
                <td>{{ grade.value.tokutei.full | number }}</td>
                <td>{{ grade.value.tokutei.half | number }}</td>
                <td>{{ grade.value.kihon.full | number }}</td>
                <td>{{ grade.value.kihon.half | number }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
  <div *ngIf="activeTab === 'csv'" class="tab-content">
    <h2>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
    <div class="section">
      <label for="csvFile">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      <input type="file" id="csvFile" accept=".csv,.xlsx" (change)="onCSVFileChange($event)">
      <button class="btn btn-primary" style="margin-left:1em;" (click)="importSalariesFromCSV()" [disabled]="!selectedCSVFile">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn btn-secondary" style="margin-left:1em;" (click)="exportSalariesToCSV()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
    <div class="section">
      <p>â€»ã“ã®æ©Ÿèƒ½ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™ã€‚</p>
      <div *ngIf="csvImportMessage" [ngClass]="{'success-message': csvImportSuccess, 'error-message': !csvImportSuccess}">
        {{ csvImportMessage }}
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" *ngIf="isEditModalOpen">
    <div class="modal-content">
      <h3>çµ¦ä¸æ˜ç´°ã®ç·¨é›†</h3>
      <form (ngSubmit)="saveEditedSalary()">
        <div class="section">
          <label>æ”¯çµ¦å¹´æœˆ</label>
          <input type="month" [(ngModel)]="editSalaryData.year_month" name="editYearMonth" required />
        </div>
        <div class="section">
          <label>æ˜ç´°å…¥åŠ›</label>
          <table class="dummy-table">
            <thead>
              <tr><th>åŒºåˆ†</th><th>é‡‘é¡</th><th>å‚™è€ƒ</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let detail of editSalaryData.details; let i = index">
                <td>
                  <select [(ngModel)]="detail.type" [name]="'editType' + i">
                    <option *ngFor="let type of salaryTypes" [value]="type.value">{{type.label}}</option>
                  </select>
                </td>
                <td>
                  <input type="number" [(ngModel)]="detail.amount" [name]="'editAmount' + i" />
                </td>
                <td>
                  <input type="text" [(ngModel)]="detail.note" [name]="'editNote' + i" />
                </td>
                <td>
                  <button type="button" (click)="removeEditSalaryDetail(i)">ï¼</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" (click)="addEditSalaryDetail()" style="margin-top: 1rem;">ï¼‹ æ˜ç´°ã‚’è¿½åŠ </button>
        </div>
        <div class="section">
          <label>ç·æ”¯çµ¦é¡</label>
          <input type="number" [value]="editTotalAmount" disabled />
          <label>èª²ç¨å¯¾è±¡é¡</label>
          <input type="number" [value]="editTaxableAmount" disabled />
          <label>ç¤¾ä¼šä¿é™ºæ–™æ§é™¤é¡</label>
          <input type="number" [value]="editSocialInsuranceDeduction" disabled />
        </div>
        <div class="section">
          <button type="submit">ä¿å­˜</button>
          <button type="button" (click)="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ æ‰‹å½“ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" *ngIf="showCustomAllowanceModal">
    <div class="modal-content">
      <h3>{{editingAllowanceId ? 'æ‰‹å½“åŒºåˆ†ã®ç·¨é›†' : 'æ‰‹å½“åŒºåˆ†ã®è¿½åŠ '}}</h3>
      <form [formGroup]="customAllowanceForm" (ngSubmit)="saveCustomAllowance()">
        <div class="form-group">
          <label for="allowanceLabel">è¡¨ç¤ºå</label>
          <input type="text" id="allowanceLabel" formControlName="label" placeholder="ä¾‹: ç‰¹åˆ¥æ‰‹å½“">
          <div class="error" *ngIf="customAllowanceForm.get('label')?.errors?.['required'] && customAllowanceForm.get('label')?.touched">
            è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" [disabled]="customAllowanceForm.invalid">ä¿å­˜</button>
          <button type="button" (click)="closeCustomAllowanceModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ æ‰‹å½“ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" *ngIf="showCustomAllowanceListModal">
    <div class="modal-content">
      <h3>æ‰‹å½“åŒºåˆ†ä¸€è¦§</h3>
      <div class="allowance-list">
        <div class="allowance-item" *ngFor="let allowance of customAllowances">
          <span>{{allowance.label}}</span>
          <div class="allowance-actions">
            <button type="button" (click)="openCustomAllowanceModal(allowance)">ç·¨é›†</button>
            <button type="button" (click)="deleteCustomAllowance(allowance)">å‰Šé™¤</button>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" (click)="openCustomAllowanceModal()">æ–°è¦è¿½åŠ </button>
        <button type="button" (click)="closeCustomAllowanceListModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
