<div class="payroll-management-container">
  <h1>給与情報管理</h1>
  <div class="tab-header">
    <button [class.active]="activeTab === 'salary'" (click)="onTabChange('salary')">💼 月額給与・手当・賞与管理</button>
    <button [class.active]="activeTab === 'auto-judge'" (click)="onTabChange('auto-judge')">🔄 報酬月額変更自動判定</button>
    <button [class.active]="activeTab === 'history'" (click)="onTabChange('history')">📜 給与情報履歴管理</button>
    <button [class.active]="activeTab === 'insurance'" (click)="onTabChange('insurance')">🏥 保険料表管理</button>
    <button [class.active]="activeTab === 'csv'" (click)="onTabChange('csv')">📥 CSVファイルインポート/エクスポート</button>
  </div>

  <!-- 月額給与・手当・賞与管理 -->
  <div *ngIf="activeTab === 'salary'" class="tab-content">
    <h2>月額給与・手当・賞与管理</h2>
    <form class="salary-form" (ngSubmit)="registerSalary($event)">
      <div class="section">
        <label>従業員選択</label>
        <input type="text" 
               placeholder="氏名・IDで検索" 
               style="min-width:180px;" 
               [(ngModel)]="searchText"
               (ngModelChange)="filterEmployees()"
               name="employeeSearch" />
        <select style="min-width:180px;" 
                [(ngModel)]="selectedEmployeeId" 
                (ngModelChange)="onEmployeeSelect()"
                name="employeeSelect">
          <option *ngFor="let emp of filteredEmployees" [value]="emp.id">
            {{ emp.last_name_kanji }} {{ emp.first_name_kanji }}（ID: {{ emp.employee_code || emp.id }}）
          </option>
        </select>
      </div>
      <div class="section">
        <label>支給年月</label>
        <input type="month" />
      </div>
      <div class="section">
        <label>明細入力</label>
        <table class="dummy-table">
          <thead>
            <tr><th>区分</th><th>金額</th><th>備考</th><th>操作</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let detail of salaryDetails; let i = index">
              <td>
                <select [(ngModel)]="detail.type" (ngModelChange)="onDetailChange()" [name]="'type' + i">
                  <option *ngFor="let type of salaryTypes" [value]="type.value">
                    {{type.label}}
                  </option>
                </select>
              </td>
              <td>
                <input type="number" 
                       [(ngModel)]="detail.amount" 
                       (ngModelChange)="onDetailChange()"
                       [name]="'amount' + i"
                       placeholder="金額" />
              </td>
              <td>
                <input type="text" 
                       [(ngModel)]="detail.note"
                       [name]="'note' + i"
                       placeholder="備考" />
              </td>
              <td>
                <button type="button" (click)="removeSalaryDetail(i)">－</button>
              </td>
            </tr>
          </tbody>
        </table>
        <button type="button" (click)="addSalaryDetail()" style="margin-top: 1rem;">＋ 明細を追加</button>
      </div>
      <div class="section">
        <label>総支給額</label>
        <input type="number" [value]="totalAmount" disabled />
        <label>課税対象額</label>
        <input type="number" [value]="taxableAmount" disabled />
        <label>社会保険料控除額</label>
        <input type="number" [value]="socialInsuranceDeduction" disabled />
      </div>
      <div class="section">
        <button type="submit">登録</button>
        <button type="button" (click)="clearForm()">クリア</button>
      </div>
      <div class="alert" style="display:none;">エラーやアラートがここに表示されます。</div>
    </form>
    <div class="section">
      <h3>登録済み給与明細一覧</h3>
      <div class="table-container">
        <table class="payroll-table" style="min-width: 1100px;">
          <thead>
            <tr>
              <th>年月</th>
              <th>基本給</th>
              <th>残業手当</th>
              <th>通勤手当</th>
              <th>その他手当</th>
              <th>総支給額</th>
              <th>課税対象額</th>
              <th>社会保険料</th>
              <th>登録日時</th>
              <th class="action-column">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let salary of registeredSalaries">
              <td>{{ salary.year_month }}</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'base')) }}円</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'overtime')) }}円</td>
              <td>{{ formatAmount(getDetailAmount(salary, 'commuting')) }}円</td>
              <td>{{ formatAmount(getOtherAllowances(salary)) }}円</td>
              <td>{{ formatAmount(salary.total_amount) }}円</td>
              <td>{{ formatAmount(salary.taxable_amount) }}円</td>
              <td>{{ formatAmount(salary.social_insurance_deduction) }}円</td>
              <td>{{ formatDate(salary.created_at) }}</td>
              <td class="action-column">
                <button type="button" (click)="editSalary(salary)">編集</button>
                <button type="button" (click)="deleteSalary(salary)">削除</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 報酬月額変更自動判定 -->
  <div *ngIf="activeTab === 'auto-judge'" class="tab-content">
    <h2>報酬月額変更自動判定</h2>
    <div class="section">
      
      <div class="alert" *ngIf="autoJudgeAlert">{{ autoJudgeAlert }}</div>
      <div class="alert" *ngIf="!autoJudgeAlert && autoJudgeSalaries.length >= 6">2等級以上の変動は検出されませんでした。</div>
      <div class="alert" *ngIf="autoJudgeSalaries.length < 6">判定には直近6ヶ月以上の給与データが必要です。</div>

      <!-- 全従業員判定一覧 -->
      <div style="margin-top:2.5em;">
        <button (click)="loadSalarySummaries()" [disabled]="isSummaryLoading">
          全従業員判定一覧を表示
        </button>
        <div *ngIf="isSummaryLoading" style="margin:1em 0; color:#888;">集計中...</div>
        <div class="table-container" *ngIf="salarySummaries.length > 0">
          <table class="payroll-table" style="min-width: 700px;">
            <thead>
              <tr>
                <th>氏名（ID）</th>
                <th>直近3ヶ月平均</th>
                <th>前3ヶ月平均</th>
                <th>増減率</th>
                <th>直近3ヶ月等級</th>
                <th>前3ヶ月等級</th>
                <th>判定結果</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let s of salarySummaries">
                <td>{{ s.name }}</td>
                <td>{{ s.avgLast3 | number:'1.0-0' }}円</td>
                <td>{{ s.avgPrev3 | number:'1.0-0' }}円</td>
                <td>{{ s.diffRate | percent:'1.1-2' }}</td>
                <td>{{ s.gradeLast3 !== null ? s.gradeLast3 : '-' }}</td>
                <td>{{ s.gradePrev3 !== null ? s.gradePrev3 : '-' }}</td>
                <td>{{ s.result }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="!isSummaryLoading && salarySummaries.length === 0" style="margin:1em 0; color:#888;">表示できるデータがありません。</div>
      </div>
    </div>
  </div>

  <!-- 給与情報履歴管理 -->
  <div *ngIf="activeTab === 'history'" class="tab-content">
    <h2>給与情報履歴管理</h2>
    <div class="section">
      <input type="text" placeholder="従業員名・IDで検索" />
      <button>検索</button>
    </div>
    <div class="section">
      <table class="dummy-table">
        <thead><tr><th>従業員</th><th>変更内容</th><th>理由</th><th>日時</th></tr></thead>
        <tbody>
          <tr><td>従業員A</td><td>基本給変更</td><td>昇給</td><td>2024/03/01</td></tr>
          <tr><td>従業員B</td><td>賞与追加</td><td>業績反映</td><td>2024/02/15</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 保険料表管理 -->
  <div *ngIf="activeTab === 'insurance'" class="tab-content">
    <h2>保険料表管理</h2>
    
    <!-- Excelファイルインポート -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">保険料表インポート</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="importYear" class="form-label">年度</label>
          <select id="importYear" class="form-select" [(ngModel)]="selectedYear">
            <option *ngFor="let y of yearOptions" [value]="y">{{ y }}年度</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="excelFile" class="form-label">協会けんぽExcelファイル</label>
          <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" (change)="onFileInputChange($event)" [disabled]="isImporting">
        </div>
        <div class="mb-3" *ngIf="sheetNames.length > 0">
          <label for="sheetSelect" class="form-label">シート選択（都道府県）</label>
          <select id="sheetSelect" class="form-select" [(ngModel)]="selectedSheetName">
            <option *ngFor="let name of sheetNames" [value]="name">{{ name }}</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" (click)="onImportClick()" [disabled]="!selectedFile || !selectedSheetName || isImporting">インポート</button>
        </div>
        <div *ngIf="importError" class="alert alert-danger">
          {{ importError }}
        </div>
        <div *ngIf="isImporting" class="alert alert-info">
          インポート中...
        </div>
      </div>
    </div>

    <!-- 保険料表エクスポート -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">保険料表エクスポート</h5>
      </div>
      <div class="card-body">
        <button class="btn btn-primary" (click)="exportToExcel()" [disabled]="!selectedPrefectureId">
          エクスポート
        </button>
      </div>
    </div>

    <!-- 保険料表表示 -->
    <div class="card" *ngIf="premiums">
      <div class="card-header">
        <h5 class="mb-0">保険料表</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="premium-table" *ngIf="premiums">
            <thead>
              <tr>
                <th>等級</th>
                <th>標準報酬月額</th>
                <th>報酬月額下限</th>
                <th>報酬月額上限</th>
                <th>一般保険料（全額）</th>
                <th>一般保険料（折半額）</th>
                <th>特定保険料（全額）</th>
                <th>特定保険料（折半額）</th>
                <th>基本保険料（全額）</th>
                <th>基本保険料（折半額）</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let grade of premiums | keyvalue : sortByGrade">
                <td>{{ grade.key }}</td>
                <td>{{ grade.value.standardSalary | number }}</td>
                <td>{{ grade.value.salaryMin | number }}</td>
                <td>{{ grade.value.salaryMax | number }}</td>
                <td>{{ grade.value.ippan.full | number }}</td>
                <td>{{ grade.value.ippan.half | number }}</td>
                <td>{{ grade.value.tokutei.full | number }}</td>
                <td>{{ grade.value.tokutei.half | number }}</td>
                <td>{{ grade.value.kihon.full | number }}</td>
                <td>{{ grade.value.kihon.half | number }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CSVファイルインポート/エクスポート -->
  <div *ngIf="activeTab === 'csv'" class="tab-content">
    <h2>CSVファイルインポート/エクスポート</h2>
    <div class="section">
      <label for="csvFile">CSVファイルを選択</label>
      <input type="file" id="csvFile" accept=".csv">
      <button class="btn btn-primary" style="margin-left:1em;" (click)="exportSalariesToCSV()">インポート</button>
      <button class="btn btn-secondary" style="margin-left:1em;" (click)="exportSalariesToCSV()">エクスポート</button>
    </div>
    <div class="section">
      <p>※この機能はサンプルUIです。実際のインポート/エクスポート処理は別途実装が必要です。</p>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div class="modal-overlay" *ngIf="isEditModalOpen">
    <div class="modal-content">
      <h3>給与明細の編集</h3>
      <form (ngSubmit)="saveEditedSalary()">
        <div class="section">
          <label>支給年月</label>
          <input type="month" [(ngModel)]="editSalaryData.year_month" name="editYearMonth" required />
        </div>
        <div class="section">
          <label>明細入力</label>
          <table class="dummy-table">
            <thead>
              <tr><th>区分</th><th>金額</th><th>備考</th><th>操作</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let detail of editSalaryData.details; let i = index">
                <td>
                  <select [(ngModel)]="detail.type" [name]="'editType' + i">
                    <option *ngFor="let type of salaryTypes" [value]="type.value">{{type.label}}</option>
                  </select>
                </td>
                <td>
                  <input type="number" [(ngModel)]="detail.amount" [name]="'editAmount' + i" />
                </td>
                <td>
                  <input type="text" [(ngModel)]="detail.note" [name]="'editNote' + i" />
                </td>
                <td>
                  <button type="button" (click)="removeEditSalaryDetail(i)">－</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" (click)="addEditSalaryDetail()" style="margin-top: 1rem;">＋ 明細を追加</button>
        </div>
        <div class="section">
          <label>総支給額</label>
          <input type="number" [value]="editTotalAmount" disabled />
          <label>課税対象額</label>
          <input type="number" [value]="editTaxableAmount" disabled />
          <label>社会保険料控除額</label>
          <input type="number" [value]="editSocialInsuranceDeduction" disabled />
        </div>
        <div class="section">
          <button type="submit">保存</button>
          <button type="button" (click)="closeEditModal()">キャンセル</button>
        </div>
      </form>
    </div>
  </div>
</div>
